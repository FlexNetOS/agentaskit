name: SLO Policy Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run every 6 hours to monitor SLO burn rate
    - cron: '0 */6 * * *'

jobs:
  slo-validation:
    runs-on: ubuntu-latest
    name: Validate SLO Policies and Burn Rate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate SLO Policy Schema
        run: |
          # Check that slo/policies.yaml exists and is valid YAML
          if [ ! -f slo/policies.yaml ]; then
            echo "ERROR: slo/policies.yaml not found"
            exit 1
          fi

          # Basic YAML syntax validation
          python3 -c "import yaml; yaml.safe_load(open('slo/policies.yaml'))" || exit 1
          echo "âœ“ SLO policy file is valid YAML"

      - name: Verify SLO Targets
        run: |
          # Extract and verify SLO targets are defined
          python3 << 'EOF'
          import yaml

          with open('slo/policies.yaml', 'r') as f:
              slo = yaml.safe_load(f)

          # Check availability target
          if 'availability' not in slo or 'target' not in slo['availability']:
              print("ERROR: Availability target not defined")
              exit(1)

          availability_target = slo['availability']['target']
          if availability_target < 99.0 or availability_target > 100.0:
              print(f"ERROR: Availability target {availability_target}% is out of range")
              exit(1)

          print(f"âœ“ Availability target: {availability_target}%")

          # Check burn rate windows
          if 'windows' not in slo['availability']:
              print("ERROR: Burn rate windows not defined")
              exit(1)

          for window in slo['availability']['windows']:
              print(f"âœ“ Burn rate window: {window['name']} (lookback: {window['lookback']}, rate: {window['burn_rate']})")

          # Check latency targets
          if 'latency' in slo:
              print(f"âœ“ Latency p95: {slo['latency']['p95_ms']}ms")
              print(f"âœ“ Latency p99: {slo['latency']['p99_ms']}ms")

          # Check startup time
          if 'startup_time' in slo:
              print(f"âœ“ Startup time p95: {slo['startup_time']['p95_ms']}ms")

          print("\nâœ… All SLO targets validated successfully")
          EOF

      - name: Calculate Error Budget
        run: |
          python3 << 'EOF'
          import yaml

          with open('slo/policies.yaml', 'r') as f:
              slo = yaml.safe_load(f)

          availability_target = slo['availability']['target']
          error_budget = 100 - availability_target

          # Calculate allowed downtime for different periods
          downtime_30d = (30 * 24 * 60) * (error_budget / 100)  # minutes
          downtime_7d = (7 * 24 * 60) * (error_budget / 100)    # minutes

          print("Error Budget Analysis:")
          print(f"  Target Availability: {availability_target}%")
          print(f"  Error Budget: {error_budget}%")
          print(f"  Allowed downtime (30 days): {downtime_30d:.2f} minutes ({downtime_30d/60:.2f} hours)")
          print(f"  Allowed downtime (7 days): {downtime_7d:.2f} minutes ({downtime_7d/60:.2f} hours)")

          # Check burn rate thresholds
          print("\nBurn Rate Alert Thresholds:")
          for window in slo['availability']['windows']:
              print(f"  {window['name']}: burn rate > {window['burn_rate']} over {window['lookback']}")
          EOF

      - name: SLO Policy Report
        run: |
          echo "ðŸ“Š SLO Policy Check Summary"
          echo "=============================="
          echo "âœ… SLO policies validated"
          echo "âœ… Error budget calculated"
          echo "âœ… Burn rate windows configured"
          echo ""
          echo "Next steps:"
          echo "- Monitor actual metrics against these SLOs"
          echo "- Set up alerting for burn rate violations"
          echo "- Review SLOs quarterly and adjust as needed"
