name: SLO Compliance Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

permissions:
  contents: read

jobs:
  slo-validation:
    name: Validate SLO Policies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate SLO policy syntax
        run: |
          python -c "
          import yaml
          import sys
          
          try:
              with open('slo/policies.yaml', 'r') as f:
                  policy = yaml.safe_load(f)
              
              # Validate required fields
              assert 'slos' in policy, 'Missing slos section'
              
              for slo in policy['slos']:
                  assert 'name' in slo, f'SLO missing name'
                  assert 'target' in slo, f'SLO {slo.get(\"name\")} missing target'
                  assert 0 <= slo['target'] <= 1, f'Invalid target for {slo[\"name\"]}'
              
              print(f'✓ Validated {len(policy[\"slos\"])} SLO definitions')
              sys.exit(0)
          except Exception as e:
              print(f'✗ SLO validation failed: {e}')
              sys.exit(1)
          "

      - name: Check SLO coverage
        run: |
          echo "## SLO Coverage Report" >> $GITHUB_STEP_SUMMARY
          python -c "
          import yaml
          
          with open('slo/policies.yaml', 'r') as f:
              policy = yaml.safe_load(f)
          
          print('| SLO | Target | Type |')
          print('|-----|--------|------|')
          for slo in policy['slos']:
              target = f\"{slo['target']*100:.2f}%\"
              slo_type = slo.get('indicator', {}).get('type', 'unknown')
              print(f\"| {slo['name']} | {target} | {slo_type} |\")
          " >> $GITHUB_STEP_SUMMARY

      - name: Verify alert rules exist
        run: |
          if [ -f "alerts/alerting-rules.yaml" ]; then
            echo "✓ Alert rules file exists"
          else
            echo "⚠️ Warning: alerts/alerting-rules.yaml not found"
          fi
