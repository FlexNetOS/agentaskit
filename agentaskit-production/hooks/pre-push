#!/bin/bash
# Pre-push hook for SoT and HASHES validation
# REF: OPS-HOOKS
# Owner: @platform

set -euo pipefail

echo "ðŸ” Running pre-push validation..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# Check if SoT was updated for modified artifacts
check_sot_updated() {
    echo -n "Checking SoT updates... "

    # Get modified files
    MODIFIED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)

    # Check if core files were modified
    CORE_MODIFIED=$(echo "$MODIFIED_FILES" | grep -E "^core/|^unified_agents/|^configs/" || true)

    if [ -n "$CORE_MODIFIED" ]; then
        # Check if SoT was also updated
        SOT_UPDATED=$(echo "$MODIFIED_FILES" | grep -E "sot\.md|sot\.json" || true)

        if [ -z "$SOT_UPDATED" ]; then
            echo -e "${YELLOW}WARNING${NC}"
            echo "  Core files modified but SoT not updated"
        else
            echo -e "${GREEN}OK${NC}"
        fi
    else
        echo -e "${GREEN}OK (no core changes)${NC}"
    fi
}

# Check if HASHES.txt exists and is valid
check_hashes() {
    echo -n "Checking hash manifests... "

    HASH_FILE="operational_hash/HASHES.txt"

    if [ ! -f "$HASH_FILE" ]; then
        echo -e "${YELLOW}WARNING${NC}"
        echo "  Hash manifest not found: $HASH_FILE"
        return 0
    fi

    HASH_COUNT=$(wc -l < "$HASH_FILE")
    if [ "$HASH_COUNT" -lt 1 ]; then
        echo -e "${RED}FAILED${NC}"
        ERRORS=$((ERRORS + 1))
        return 1
    fi

    echo -e "${GREEN}OK ($HASH_COUNT entries)${NC}"
}

# Run all checks
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Pre-push Quality Gate"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

check_sot_updated
check_hashes

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Pre-push validation FAILED${NC}"
    exit 1
fi

echo -e "${GREEN}Pre-push validation PASSED${NC}"
exit 0
