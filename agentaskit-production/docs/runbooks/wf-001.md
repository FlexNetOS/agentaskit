# Runbook: 7-Phase Workflow Orchestration (WF-001)

**REF:** OPS-RUNBOOK, WF-001
**Owner:** @orchestration
**Status:** Active
**Last Updated:** 2025-10-05

## Overview

This runbook covers the operation, monitoring, and troubleshooting of the 7-phase workflow with 928-agent orchestration.

## Prerequisites

- Access to Kubernetes cluster
- Grafana dashboard access
- kubectl configured for production
- On-call escalation path known

## Service Health Checks

### Quick Health Check

```bash
# Check all orchestration pods
kubectl get pods -n agentaskit-production -l app=orchestrator

# Check workflow controller status
curl -s https://api.agentaskit.io/api/v1/health/workflows | jq .

# Check agent pool health
curl -s https://api.agentaskit.io/api/v1/agents/health | jq .
```

### Expected Output

```json
{
  "status": "healthy",
  "phases": {
    "active": 3,
    "pending": 4,
    "completed": 0
  },
  "agents": {
    "total": 928,
    "healthy": 925,
    "degraded": 3,
    "unhealthy": 0
  }
}
```

## Common Issues & Resolutions

### Issue 1: Phase Stuck in Pending

**Symptoms:**
- Phase not progressing for >5 minutes
- No errors in logs
- Agent pool healthy

**Diagnosis:**

```bash
# Check phase status
kubectl logs -n agentaskit-production deployment/orchestrator --tail=100 | grep -i phase

# Check pending tasks
kubectl exec -n agentaskit-production deployment/orchestrator -- \
  /app/bin/check-pending-tasks
```

**Resolution:**

1. Check for blocked dependencies
2. Verify prerequisite phases completed
3. If stuck, trigger manual phase advance:

```bash
# Manual phase advance (use with caution)
curl -X POST https://api.agentaskit.io/api/v1/workflows/advance \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{"workflow_id": "wf-xxx", "target_phase": 3}'
```

### Issue 2: Agent Pool Degraded

**Symptoms:**
- >5% agents unhealthy
- Increased task latency
- Queue depth growing

**Diagnosis:**

```bash
# List unhealthy agents
kubectl exec -n agentaskit-production deployment/agent-manager -- \
  /app/bin/list-agents --status=unhealthy

# Check agent logs
kubectl logs -n agentaskit-production -l app=agent-worker --tail=50
```

**Resolution:**

1. Restart unhealthy agent pods:

```bash
kubectl delete pod -n agentaskit-production -l status=unhealthy
```

2. If persistent, scale up healthy agents:

```bash
kubectl scale deployment/agent-worker --replicas=150 -n agentaskit-production
```

### Issue 3: Canary Failure

**Symptoms:**
- Canary metrics breach threshold
- Rollback triggered
- Alerts firing

**Diagnosis:**

```bash
# Check canary status
kubectl get canary agentaskit-canary -n agentaskit-production -o yaml

# Review canary metrics
curl -s https://api.agentaskit.io/api/v1/canary/metrics | jq .
```

**Resolution:**

1. Verify rollback completed
2. Investigate root cause in logs
3. Create incident ticket
4. Fix and re-deploy

## Rollback Procedure

### Automated Rollback

Rollback triggers automatically when:
- Error rate >1%
- Latency p99 >200ms
- Canary health check fails

### Manual Rollback

```bash
# Rollback to previous version
kubectl rollout undo deployment/orchestrator -n agentaskit-production
kubectl rollout undo deployment/agent-manager -n agentaskit-production

# Verify rollback
kubectl rollout status deployment/orchestrator -n agentaskit-production
```

**Target:** Rollback completes in <5 minutes

## Escalation Path

| Severity | Contact | Response Time |
|----------|---------|---------------|
| P1 (Critical) | Page @orchestration-oncall | 15 min |
| P2 (High) | Slack #orchestration-alerts | 30 min |
| P3 (Medium) | Create issue | 4 hours |

## Dashboards

- [Orchestrator Health](https://grafana.agentaskit.io/d/orchestrator)
- [Agent Pool Status](https://grafana.agentaskit.io/d/agents)
- [7-Phase Progress](https://grafana.agentaskit.io/d/7phase)

## Evidence

- Runbook tests: `TEST/rollback/*.log`
- Automation: `scripts/runbooks/`
- Alerts: `alerts/wf-001.yaml`

## Related

- [DEP-CANARY](../deploy/canary/plan.md) - Canary deployment
- [OBS-001](../../.todo) - Observability
- [VER-001](../../.todo) - Triple verification
