# Distributed Tracing Configuration
# REF: OBS-TRACING
# Owner: @platform
# Last Updated: 2025-10-05

# OpenTelemetry Configuration
otlp:
  enabled: true
  endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:-localhost:4317}
  protocol: grpc
  compression: gzip
  timeout_seconds: 10
  headers:
    authorization: ${OTEL_EXPORTER_OTLP_HEADERS:-}

# Service identification
service:
  name: agentaskit
  version: ${SERVICE_VERSION:-unknown}
  namespace: agentaskit-production
  instance_id: ${POD_NAME:-unknown}

# Sampling configuration
sampling:
  # Default sampling rate (1.0 = 100%, 0.1 = 10%)
  default_rate: 0.1

  # Per-endpoint sampling
  endpoints:
    /api/v1/health:
      rate: 0.01  # 1% for health checks
    /api/v1/agents/execute:
      rate: 1.0   # 100% for critical paths
    /api/v1/workflows/trigger:
      rate: 1.0   # 100% for workflows

  # Error sampling - always capture errors
  always_sample_errors: true

  # Parent-based sampling
  parent_based: true

  # Rate limiting (max traces per second)
  rate_limit: 1000

# Trace propagation
propagation:
  # W3C Trace Context
  - traceparent
  - tracestate
  # B3 (for legacy compatibility)
  - b3
  - b3multi

# Span configuration
spans:
  # Maximum attributes per span
  max_attributes: 128

  # Maximum events per span
  max_events: 128

  # Maximum links per span
  max_links: 128

  # Attribute value length limit
  max_attribute_length: 2048

# Resource attributes
resource:
  attributes:
    deployment.environment: production
    cloud.provider: ${CLOUD_PROVIDER:-unknown}
    cloud.region: ${CLOUD_REGION:-unknown}
    k8s.cluster.name: ${K8S_CLUSTER_NAME:-unknown}
    k8s.namespace.name: ${K8S_NAMESPACE:-agentaskit-production}

# Instrumentation
instrumentation:
  # HTTP client/server
  http:
    enabled: true
    capture_headers:
      request:
        - x-request-id
        - x-correlation-id
        - user-agent
      response:
        - x-request-id
        - content-type
    sanitize_headers:
      - authorization
      - cookie
      - set-cookie

  # gRPC
  grpc:
    enabled: true
    capture_metadata:
      - x-request-id

  # Database
  database:
    enabled: true
    capture_statements: false  # Privacy - don't capture SQL
    capture_statement_parameters: false

  # Message queues
  messaging:
    enabled: true
    capture_payload: false  # Privacy

# Exporters
exporters:
  # Primary: OTLP
  otlp:
    enabled: true

  # Backup: Jaeger
  jaeger:
    enabled: false
    endpoint: ${JAEGER_ENDPOINT:-}

  # Debug: Console
  console:
    enabled: false
    pretty_print: true

# Batch processing
batch:
  max_queue_size: 2048
  max_export_batch_size: 512
  scheduled_delay_ms: 5000
  export_timeout_ms: 30000

# Metrics from traces
trace_metrics:
  enabled: true
  histograms:
    enabled: true
    buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]

  # Exemplars for trace-metric correlation
  exemplars:
    enabled: true
    max_per_metric: 5
