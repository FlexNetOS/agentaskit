# Pixi configuration for AgentAsKit
# REF: ADR-0005 Modern Tooling Strategy
# All scripts use Nushell for cross-platform compatibility

[project]
name = "agentaskit"
version = "0.1.0"
description = "AgentAsKit Production System"
channels = ["conda-forge"]
platforms = ["linux-64", "osx-arm64", "osx-64", "win-64"]

[dependencies]
# Core development tools - ALL managed by pixi for consistency
python = ">=3.11"
rust = ">=1.70"

# Nushell - PRIMARY cross-platform shell for all scripts
nushell = ">=0.90"

# Node.js ecosystem - required for web tooling and pnpm
nodejs = ">=20"
pnpm = ">=8"

# Bash for legacy CI compatibility (minimal use, prefer nushell)
bash = "*"

# Build acceleration (faster rebuilds)
sccache = "*"

# Rust tooling enhancements
cargo-binstall = "*"  # Fast binary installation
cargo-watch = "*"     # Auto-rebuild on file changes

# Protobuf for gRPC (used by core/build.rs)
protobuf = ">=3.0"

# pkg-config for system library detection
pkg-config = "*"

# Data science / AI (for agent workflows)
numpy = ">=1.24"
pandas = ">=2.0"

# Git (ensure consistent version across platforms)
git = "*"

# mise - Tool version manager (complements pixi for local dev workflow)
# Provides .mise.toml support for developers who prefer mise tasks
mise = "*"

[tasks]
# Bootstrap - single cross-platform script
bootstrap = "nu tools/bootstrap.nu"

# Core build tasks (simple commands work directly)
build = "cargo build --release"
build-dev = "cargo build"
test = "cargo test --all"
fmt = "cargo fmt --all"
check = "cargo check --all"

# Lint with nushell for cross-platform &&
lint = { cmd = "nu -c 'cargo clippy --all-targets --all-features -- -D warnings; cargo fmt --check'" }

# Documentation
doc = "cargo doc --no-deps --document-private-items"

# Clean all build artifacts (nushell for glob)
clean = { cmd = "nu -c 'cargo clean; glob tools/external/*/target | each { rm -rf $in }'" }

# Build with sccache
build-cached = { cmd = "cargo build --release", env = { RUSTC_WRAPPER = "sccache" } }

# Build external tools
build-tools = { cmd = "nu -c 'for tool in [nushell coreutils rusty-tags] { cd $\"tools/external/($tool)\"; cargo build --release }'" }

# Aider AI pair programming
aider = "aider --config .aider.conf.yml"

[feature.dev.dependencies]
# Development-only dependencies
pytest = "*"
black = "*"
ruff = "*"
pre-commit = "*"

[environments]
default = { features = [], solve-group = "default" }
dev = { features = ["dev"], solve-group = "default" }

# Pixi activation - ensures consistent environment across all platforms
[activation]
# SECURITY NOTE:
# - The script(s) listed here are executed automatically when entering a pixi shell.
# - `configs/nushell/pixi-activate.nu` may source additional files such as
#   `configs/nushell/env.nu`. Treat all of these Nushell scripts as trusted code.
# - In shared or multi-user environments, ensure these files are only writable by
#   trusted users (e.g., owner-writable, not group/world-writable) and consider
#   enforcing integrity checks (e.g., checksums verified in CI) to detect tampering.
scripts = ["configs/nushell/pixi-activate.nu"]

# Auto-activate pixi environment for supported shells
[activation.env]
# Ensure pixi-managed tools are first in PATH
PIXI_IN_SHELL = "true"
