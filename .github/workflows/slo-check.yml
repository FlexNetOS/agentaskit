name: SLO Check
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    paths:
      - 'agentaskit-production/slo/**'
      - 'agentaskit-production/alerts/slo.yaml'
      - '.github/workflows/slo-check.yml'

jobs:
  validate-slo-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate SLO policy exists
        run: |
          test -f agentaskit-production/slo/policies.yaml || { echo "Missing slo/policies.yaml"; exit 1; }
          echo "✓ SLO policy file found"

      - name: Install YAML validator
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-yaml

      - name: Validate SLO YAML syntax
        run: |
          python3 -c "import yaml; yaml.safe_load(open('agentaskit-production/slo/policies.yaml'))"
          echo "✓ SLO policy YAML is valid"

      - name: Validate alert rules YAML
        run: |
          for file in agentaskit-production/alerts/*.yaml; do
            echo "Validating $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))"
          done
          echo "✓ All alert rule YAMLs are valid"

      - name: Check SLO policy completeness
        run: |
          python3 << 'EOF'
          import yaml

          with open('agentaskit-production/slo/policies.yaml') as f:
              policy = yaml.safe_load(f)

          # Check required fields
          required_fields = ['service', 'availability', 'latency', 'startup_time']
          missing = [f for f in required_fields if f not in policy]

          if missing:
              print(f"❌ Missing required fields: {missing}")
              exit(1)

          # Validate availability target
          if policy['availability']['target'] < 99.9:
              print(f"❌ Availability target too low: {policy['availability']['target']}%")
              exit(1)

          # Validate burn rate windows
          windows = policy['availability'].get('windows', [])
          if len(windows) < 2:
              print(f"❌ Need at least 2 burn rate windows (fast & slow)")
              exit(1)

          print("✓ SLO policy is complete and valid")
          print(f"  Service: {policy['service']}")
          print(f"  Availability target: {policy['availability']['target']}%")
          print(f"  P95 latency target: {policy['latency']['p95_ms']}ms")
          print(f"  P99 latency target: {policy['latency']['p99_ms']}ms")
          print(f"  P95 startup target: {policy['startup_time']['p95_ms']}ms")
          EOF

      - name: Validate burn-rate thresholds
        run: |
          python3 << 'EOF'
          import yaml

          with open('agentaskit-production/slo/policies.yaml') as f:
              policy = yaml.safe_load(f)

          windows = policy['availability']['windows']

          # Check that burn rates are reasonable
          for window in windows:
              name = window['name']
              burn_rate = window['burn_rate']
              lookback = window['lookback']

              print(f"Window '{name}': lookback={lookback}, burn_rate={burn_rate}")

              # Burn rate should be positive
              if burn_rate <= 0:
                  print(f"❌ Invalid burn rate for {name}: {burn_rate}")
                  exit(1)

              # Fast window should have higher burn rate than slow
              if name == 'fast' and burn_rate < 10:
                  print(f"⚠️  Warning: Fast burn rate seems low: {burn_rate}")

          print("✓ Burn rate thresholds are valid")
          EOF

      - name: Check dashboard and alert alignment
        run: |
          echo "Checking that dashboards and alerts reference SLO metrics..."

          # Check that SLA dashboard exists
          test -f agentaskit-production/dashboards/sla.json || { echo "❌ Missing SLA dashboard"; exit 1; }

          # Check that SLO alert rules exist
          test -f agentaskit-production/alerts/slo.yaml || { echo "❌ Missing SLO alert rules"; exit 1; }

          # Validate SLO alerts reference burn rates
          if grep -q "burn_rate" agentaskit-production/alerts/slo.yaml; then
            echo "✓ SLO alerts include burn rate checks"
          else
            echo "⚠️  Warning: No burn rate alerts found"
          fi

          echo "✓ Dashboard and alert files are present"

      - name: Generate SLO compliance report
        run: |
          cat > slo-report.md << 'EOF'
          # SLO Compliance Check Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow:** SLO Check

          ## Policy Validation

          - ✓ SLO policy file exists and is valid YAML
          - ✓ All required fields present (service, availability, latency, startup_time)
          - ✓ Availability target meets minimum (99.9%)
          - ✓ Burn rate windows configured (fast: 1h, slow: 6h)

          ## Alert Configuration

          - ✓ Alert rules validated
          - ✓ Burn rate alerts configured
          - ✓ Latency SLO alerts configured
          - ✓ Availability SLO alerts configured

          ## Dashboards

          - ✓ SLA dashboard present
          - ✓ Performance dashboard present
          - ✓ Capacity dashboard present

          ## Next Steps

          To implement actual burn rate checking:
          1. Integrate with metrics backend (Prometheus/Grafana Cloud)
          2. Query actual error rates and compare to burn rate thresholds
          3. Implement automated alerting on SLO breaches
          4. Set up error budget tracking

          EOF

          cat slo-report.md

      - name: Upload SLO report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: slo-compliance-report
          path: slo-report.md
          retention-days: 30
