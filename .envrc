# direnv configuration for AgentAskit
# REF: ADR-0005 Modern Tooling Strategy
# Automatically loads environment when entering directory
# Supports: Linux, macOS, WSL

# Detect OS
case "$(uname -s)" in
    Linux*)  AGENTASKIT_OS="linux" ;;
    Darwin*) AGENTASKIT_OS="macos" ;;
    MINGW*|MSYS*|CYGWIN*) AGENTASKIT_OS="windows" ;;
    *)       AGENTASKIT_OS="unknown" ;;
esac
export AGENTASKIT_OS

# Project root (portable)
export AGENTASKIT_ROOT="${PWD}"

# XDG Base Directory compliance (works on macOS too)
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"

# Rust XDG compliance
export CARGO_HOME="${CARGO_HOME:-$XDG_DATA_HOME/cargo}"
export RUSTUP_HOME="${RUSTUP_HOME:-$XDG_DATA_HOME/rustup}"

# Use mise for tool management (if available)
if has mise; then
    eval "$(mise activate bash)"
    eval "$(mise hook-env -s bash)"
fi

# Use pixi for conda environment (if available)
if has pixi; then
    eval "$(pixi shell-hook)"
fi

# Project tool paths - use unified bin directory first
PATH_add "$AGENTASKIT_ROOT/tools/bin"

# Fallback to individual tool paths if bin symlinks don't exist
if [[ ! -L "$AGENTASKIT_ROOT/tools/bin/nu" ]]; then
    PATH_add "$AGENTASKIT_ROOT/tools/external/nushell/target/release"
fi
if [[ ! -L "$AGENTASKIT_ROOT/tools/bin/chezmoi" ]]; then
    PATH_add "$AGENTASKIT_ROOT/tools/external/chezmoi"
fi

# Additional tool paths
PATH_add "$AGENTASKIT_ROOT/tools/external/coreutils/target/release"
PATH_add "$AGENTASKIT_ROOT/tools/external/rusty-tags/target/release"

# Python user bin (for aider)
PATH_add "$HOME/.local/bin"

# macOS-specific: Homebrew paths
if [[ "$AGENTASKIT_OS" == "macos" ]]; then
    if [[ -d "/opt/homebrew/bin" ]]; then
        PATH_add "/opt/homebrew/bin"
    fi
fi

# Aider configuration
export AIDER_CONFIG="$AGENTASKIT_ROOT/.aider.conf.yml"

# Load local .env if present (gitignored)
dotenv_if_exists .env.local

# Warn if critical tools are missing
if ! has cargo; then
    log_status "WARNING: cargo not found - Rust toolchain not installed"
fi
